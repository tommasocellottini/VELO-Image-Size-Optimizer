@page "/"
@using Velo.Classes
@inject IJSRuntime JS

<div class="velo-card">
    <h2 class="text-center mb-4"><span class="LogoFont">VELO </span> <span class="LogoDescription">Image Size
            Optimizer</span></h2>

    <div class="upload-zone mb-4">
        <input type="file" @onchange="OnFilesSelected" @ref="fileInputRef" id="fileInput" multiple
            class="form-control" />
    </div>

    @if (pendingFiles.Any())
    {
        <div class="file-manager">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-muted small uppercase mb-0">Files (@pendingFiles.Count)</h5>
                @if (pendingFiles.Any(f => f.Data != null))
                {
                    <button class="btn btn-success btn-sm shadow" @onclick="DownloadZip">
                        📦 Download All .ZIP
                    </button>
                }
            </div>

            @foreach (var file in pendingFiles)
            {
                <div
                    class="file-row p-3 mb-2 bg-dark border @(file.Data != null ? "border-success" : "border-secondary") rounded shadow-sm">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="text-truncate" style="max-width: 65%;">
                            <span class="text-white fw-bold">@file.Name</span>
                            <div class="d-flex gap-2 mt-1">
                                <small class="text-muted">Orig: @(file.Size / 1024) KB</small>
                                @if (file.CompressedSize.HasValue)
                                {
                                    <small class="text-success fw-bold">Final: @file.CompressedSize KB</small>
                                    <span class="badge bg-success text-dark" style="font-size: 0.7rem;">-@file.Savings%</span>
                                }
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            @* TASTO RESET QUALITÀ *@
                            <button class="btn btn-sm btn-outline-info border-0" title="Reset Quality to 75%"
                                @onclick="() => ResetQuality(file)">
                                <span style="font-size: 1.1rem;">⟳</span>
                            </button>

                            @* TASTO CANCELLA *@
                            <button class="btn btn-sm btn-outline-danger border-0" @onclick="() => RemoveFile(file)">
                                ✕
                            </button>
                        </div>
                    </div>

                    <div class="row align-items-center g-2 mt-2 border-top border-secondary pt-2">
                        <div class="col">
                            <input type="range" class="form-range" min="1" max="100" @bind="file.Quality"
                                @bind:event="oninput" />
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-primary">Q: @file.Quality%</span>
                        </div>
                        <div class="col-auto">
                            @if (file.Url != null)
                            {
                                <a href="@file.Url" download="@file.Name" class="btn btn-sm btn-success">Download</a>
                            }
                        </div>
                    </div>
                </div>
            }

            <button class="btn btn-primary w-100 py-3 fw-bold mt-3 shadow-lg" @onclick="StartConversion"
                disabled="@isProcessing">
                @(isProcessing ? "RE-OPTIMIZING..." : "FORCE RE-OPTIMIZE ALL")
            </button>
        </div>
    }
</div>

@code {
    private bool isProcessing = false;
    private ElementReference fileInputRef;
    private List<FileEntry> pendingFiles = new();

    private async Task OnFilesSelected(ChangeEventArgs e)
    {
        var newFiles = await JS.InvokeAsync<List<FileEntry>>("getSelectedFilesInfo", fileInputRef);

        foreach (var file in newFiles)
        {
            // Impostiamo la qualità di default per il caricamento
            file.Quality = 75;
            pendingFiles.Add(file);

            // OTTIMIZZAZIONE IMMEDIATA AL CARICAMENTO
            await OptimizeSingleFile(file);
        }

        StateHasChanged();
    }

    private async Task StartConversion()
    {
        if (!pendingFiles.Any()) return;
        isProcessing = true;

        foreach (var file in pendingFiles)
        {
            await OptimizeSingleFile(file);
        }

        isProcessing = false;
        StateHasChanged();
    }

    private async Task OptimizeSingleFile(FileEntry file)
    {
        try
        {
            var res = await JS.InvokeAsync<NativeResult>("compressNativeVelo", file.FileId, file.Quality);

            file.Url = res.Url;
            file.Data = res.Data;
            file.CompressedSize = res.Data.Length / 1024;
            file.Savings = Math.Round(100 - ((double)res.Data.Length / res.OrigSize * 100), 1);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore su {file.Name}: {ex.Message}");
        }
    }

    private async Task RemoveFile(FileEntry file)
    {
        pendingFiles.Remove(file);
        await JS.InvokeVoidAsync("removeFromCache", file.FileId);
    }

    private async Task DownloadZip()
    {
        var zipPayload = pendingFiles.Where(f => f.Data != null).Select(r => new
        {
            fileName = r.Name,
            data = Convert.ToBase64String(r.Data!)
        }).ToList();

        var json = System.Text.Json.JsonSerializer.Serialize(zipPayload);
        await JS.InvokeVoidAsync("downloadAsZip", json);
    }

    private async Task ResetQuality(FileEntry file)
    {
        // Resetta la qualità al valore di default (75)
        file.Quality = 75;

        // Riesegue l'ottimizzazione per aggiornare il peso del file
        await OptimizeSingleFile(file);

        StateHasChanged();
    }
}