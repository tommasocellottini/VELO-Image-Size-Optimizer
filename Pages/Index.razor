@page "/"
@using Velo.Classes
@inject IJSRuntime JS

@using System.Globalization
@using System.IO
@using System.IO.Compression

<div class="container-fluid vh-100 overflow-hidden velo-bg d-flex flex-column" @ref="dropZoneElement">
    <button class="btn btn-link text-white-50 position-absolute top-right-btn"
        @onclick="() => showHelp = !showHelp">
        About
    </button>

    @if (showHelp)
    {
        <div class="position-fixed top-0 start-0 w-100 h-100 overlay-backdrop" @onclick="() => showHelp = false">
        </div>
        <div class="position-absolute text-white p-3 rounded shadow-lg help-popover">
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2" aria-label="Close"
                @onclick="() => showHelp = false"></button>
            <div class="text-start pe-4">
                <strong>Velo is free and respects your privacy.</strong><br>
                <small class="text-white-50">All processing is done locally in your browser. Your files are never uploaded
                    to any server.</small>
                <hr class="border-secondary my-2">
                <small class="text-white-50">
                    This project is open-source. You can find the code on
                    <a href="https://github.com/tommasocellottini/VELO-Image-Size-Optimizer" target="_blank"
                        class="text-white">GitHub</a>.
                </small>
                <hr class="border-secondary my-2">
                <small class="text-white-50">
                    Made by Tommaso Cellottini - 2024
                </small>
            </div>
        </div>
    }

    @if (showPrivacy)
    {
        <div class="position-fixed top-0 start-0 w-100 h-100 overlay-backdrop" @onclick="() => showPrivacy = false">
        </div>
        <div class="position-absolute text-white p-4 rounded shadow-lg overflow-auto privacy-modal">
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" aria-label="Close"
                @onclick="() => showPrivacy = false"></button>

            <h3 class="mb-4 fw-bold"><img src="VeloLogoText.svg" alt="VELO" style="height: 30px; margin-right: 10px;" /> Privacy Policy</h3>
            
            <p class="text-white-50 mb-4">Last updated: @DateTime.Now.ToString("MMMM dd, yyyy", System.Globalization.CultureInfo.InvariantCulture)</p>

            <h5 class="text-primary mb-2">1. Introduction</h5>
            <p class="small">Welcome to VELO Image Size Optimizer. We are committed to protecting your privacy. This Privacy Policy explains how our application handles your data.</p>

            <h5 class="text-primary mb-2 mt-3">2. Local Processing (Client-Side)</h5>
            <p class="small"><strong>VELO is designed with privacy as a core feature.</strong> Unlike many other online tools, VELO operates entirely within your web browser.</p>
            
            <div class="alert bg-opacity-10 border-success text-white p-2 mb-2">
                <small><strong>Your files are never uploaded to any server.</strong></small>
            </div>
            <p class="small">When you select or drag images into the application:</p>
            <ul class="small">
                <li>The image processing happens locally on your device's processor (CPU).</li>
                <li>Your images never leave your computer or mobile device.</li>
                <li>We do not have access to view, store, or copy your files.</li>
            </ul>

            <h5 class="text-primary mb-2 mt-3">3. Data Collection</h5>
            <p class="small">Since the application runs locally:</p>
            <ul class="small">
                <li><strong>No Personal Data:</strong> We do not collect names, email addresses, or IP addresses.</li>
                <li><strong>No Analytics:</strong> We do not use third-party analytics services.</li>
                <li><strong>No Cookies:</strong> This application does not use cookies.</li>
            </ul>

            <h5 class="text-primary mb-2 mt-3">4. Hosting</h5>
            <p class="small">This website is served via a static hosting provider. The hosting provider may collect standard server logs (IP address, user agent) for security. This is standard internet behavior.</p>

            <h5 class="text-primary mb-2 mt-3">5. Open Source</h5>
            <p class="small">VELO is an open-source project. You can verify the code on our <a href="https://github.com/tommasocellottini/VELO-Image-Size-Optimizer" target="_blank" class="text-info">GitHub repository</a>.</p>

            <h5 class="text-primary mb-2 mt-3">6. Contact</h5>
            <p class="small">If you have any questions, please open an issue on our GitHub repository.</p>
        </div>
    }

    <input type="file" @onchange="OnFilesSelected" @ref="fileInputRef" id="fileInput" multiple style="display: none;" />

    @if (!pendingFiles.Any())
    {
        <div>
            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center init-overlay">
                <h2 class="mb-0 text-center"><img src="VeloLogoText.svg" alt="VELO" class="logo-lg" /></h2>
                <button class="btn btn-primary btn-lg shadow-glow z-interactive"
                    @onclick="TriggerFileSelect">
                    Select Images
                </button>
                <div class="text-white-50">or drop an image to start</div>
            </div>
        </div>
    }
    else
    {
        <div class="velo-header p-3 d-flex align-items-center justify-content-between">
            <div class="upload-zone w-500">

            </div>
            <h2 class="mb-0 flex-grow-1 text-center"><img src="VeloLogoText.svg" alt="VELO" class="logo-sm" /></h2>
            <div class="d-flex justify-content-end w-500">

            </div>
        </div>
    }

    <div class="row flex-grow-1 overflow-hidden">
        <div class="col-3 velo-bg p-3 overflow-auto">

            <div class="d-flex justify-content-between align-items-center mb-3 h-30">

                @if (pendingFiles.Any())
                {
                    <button class="btn btn-primary btn-sm z-interactive w-80"
                        @onclick="TriggerFileSelect">
                        Add IMG
                    </button>

                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm bg-dark text-white border-secondary p-0 ps-1 w-80"
                            value="@globalFormat" @onchange="ChangeGlobalFormat">
                            <option value="jpeg">JPG</option>
                            <option value="webp">WEBP</option>
                            <option value="png">PNG</option>
                        </select>
                        <button class="btn btn-danger btn-sm w-80" @onclick="ClearAllFiles">
                            Clear</button>
                        <button class="btn btn-success btn-sm w-80" @onclick="DownloadZip">
                            Zip All
                        </button>
                    </div>
                }
            </div>

            @if (pendingFiles.Any())
            {
                <h5 class="text-muted small text-uppercase mb-2">Selected files (@pendingFiles.Count)</h5>

                @foreach (var file in pendingFiles)
                {
                    <div class="file-item p-2 mb-2 rounded @(selectedFile == file ? "bg-opacity-25 border border-2 border-primary" : "border border-secondary")"
                        style="cursor: pointer;"
                        @onclick="() => SelectFile(file)">

                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="text-truncate max-w-75">
                                <div class="text-white fw-bold small">@file.Name</div>
                                <div class="mt-1">
                                    <small class="text-muted">Before: @FormatSize(file.Size)</small>
                                    @if (file.CompressedSize.HasValue)
                                    {
                                        bool isLarger = file.CompressedSize.Value > file.Size;
                                        <small class="@(isLarger ? "text-danger" : "text-success") fw-bold ms-2">
                                            After: @FormatSize(file.CompressedSize.Value)
                                            @if (file.Savings.HasValue)
                                            {
                                                <span>(@(file.Savings.Value >= 0 ? $"-{file.Savings.Value:F1}%" :
                                                                                        $"+{Math.Abs(file.Savings.Value):F1}%"))</span>
                                            }
                                        </small>
                                    }
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm text-primary p-1" @onclick:stopPropagation="true"
                                    @onclick="() => DownloadSingleFile(file)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon-lg">
                                        <path
                                            d="M352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 306.7L246.6 265.3C234.1 252.8 213.8 252.8 201.3 265.3C188.8 277.8 188.8 298.1 201.3 310.6L297.3 406.6C309.8 419.1 330.1 419.1 342.6 406.6L438.6 310.6C451.1 298.1 451.1 277.8 438.6 265.3C426.1 252.8 405.8 252.8 393.3 265.3L352 306.7L352 96zM160 384C124.7 384 96 412.7 96 448L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 448C544 412.7 515.3 384 480 384L433.1 384L376.5 440.6C345.3 471.8 294.6 471.8 263.4 440.6L206.9 384L160 384zM464 440C477.3 440 488 450.7 488 464C488 477.3 477.3 488 464 488C450.7 488 440 477.3 440 464C440 450.7 450.7 440 464 440z" />
                                    </svg>
                                </button>
                                <button class="btn btn-sm text-primary p-1" @onclick:stopPropagation="true"
                                    @onclick="() => ResetQuality(file)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon-md">
                                        <path
                                            d="M48.5 224H40c-13.3 0-24-10.7-24-24V72c0-9.7 5.8-18.5 14.8-22.2s19.3-1.7 26.2 5.2L98.6 96.6c87.6-86.5 228.7-86.2 315.8 1c87.5 87.5 87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3c-62.2-62.2-162.7-62.5-225.3-1L185 183c6.9 6.9 8.9 17.2 5.2 26.2s-12.5 14.8-22.2 14.8H48.5z" />
                                    </svg>
                                </button>
                                <button class="btn btn-sm text-danger p-1" @onclick:stopPropagation="true"
                                    @onclick="() => RemoveFile(file)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="icon-lg">
                                        <path
                                            d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="row align-items-center g-2 border-top border-secondary pt-2 mt-1">
                            <div class="col-auto">
                                <select class="form-select form-select-sm bg-dark text-white border-secondary p-0 ps-1 select-xs"
                                    value="@file.OutputFormat"
                                    @onchange="@(e => ChangeFormat(e, file))" @onclick:stopPropagation="true">
                                    <option value="jpeg">JPG</option>
                                    <option value="webp">WEBP</option>
                                    <option value="png">PNG</option>
                                </select>
                            </div>
                            <div class="col" style="    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 1rem;">
                                <input type="range" class="form-range" min="1" max="100" step="1" value="@file.Quality"
                                    @oninput="(e) => UpdateQualityValue(e, file)" @onchange="() => OptimizeSingleFile(file)"
                                    @onclick:stopPropagation="true" />
                                <span class="badge bg-primary badge-xs">@file.Quality%</span>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
        <div class="col-9 velo-bg p-0 d-flex flex-column align-items-center justify-content-center position-relative overflow-hidden">
            @if (selectedFile != null)
            {
                <div class="preview-stage @(selectedFile != null ? "border border-2 border-primary shadow-glow" : "")">
                    @if (!string.IsNullOrEmpty(selectedFile.Url))
                    {
                        <div class="velo-container" @ref="veloContainerRef" tabindex="0">
                            <div class="zoom-controls">
                                <button class="zoom-btn before-btn @(showingOriginal ? "active" : "")"
                                    @onclick="() => showingOriginal = true" title="Show Before">Before</button>
                                <button class="zoom-btn after-btn @(!showingOriginal ? "active" : "")"
                                    @onclick="() => showingOriginal = false" title="Show After">After</button>
                                <button class="zoom-btn reset-btn ms-2" @onclick="ResetZoom" title="Reset Zoom">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-md" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                                    </svg>
                                </button>
                            </div>

                            <div class="zoom-frame">
                                <img src="@selectedFile.OriginalUrl" class="frame-img original-image @(showingOriginal ? "d-block" : "d-none")" draggable="false" />
                                <img src="@selectedFile.Url" class="frame-img optimized-image @(showingOriginal ? "d-none" : "d-block")" draggable="false" />
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
    <div class="text-center text-white-50 py-2 footer-info">
        Velo is free and respects your privacy. All processing is done locally. Your files are never uploaded.
        <span class="mx-2">|</span>
        <a href="#" @onclick="() => showPrivacy = true" @onclick:preventDefault class="text-white-50">Privacy Policy</a>
    </div>
</div>

@code {
    private ElementReference dropZoneElement;
    private ElementReference fileInputRef;
    private List<FileEntry> pendingFiles = new();

    private FileEntry? selectedFile;
    private ElementReference veloContainerRef;
    private string? lastZoomInitFileId;
    private bool showingOriginal = false;
    private bool showHelp = false;
    private bool showPrivacy = false;
    private string globalFormat = "jpeg";


    private void SelectFile(FileEntry file)
    {
        selectedFile = file;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("enableDragDrop", dropZoneElement, fileInputRef);
            await JS.InvokeVoidAsync("enablePaste", fileInputRef);
        }

        if (selectedFile != null && !string.IsNullOrEmpty(selectedFile.Url) && selectedFile.FileId != lastZoomInitFileId)
        {
            await JS.InvokeVoidAsync("previewZoom.init", veloContainerRef);
            lastZoomInitFileId = selectedFile.FileId;
        }
    }

    private async Task OnFilesSelected(ChangeEventArgs e)
    {
        var newFiles = await JS.InvokeAsync<List<FileEntry>>("getSelectedFilesInfo", fileInputRef);

        foreach (var file in newFiles)
        {
            // Check if file with same name already exists in pendingFiles
            if (pendingFiles.Any(f => f.Name == file.Name))
            {
                Console.WriteLine($"File {file.Name} is already in the list");
                continue;
            }

            file.Quality = 75;

            // Ora l'ID esiste sicuramente in cache
            file.OriginalUrl = await JS.InvokeAsync<string>("getFileUrl", file.FileId);

            pendingFiles.Add(file);
            if (selectedFile == null) selectedFile = file;

            // Eseguiamo l'ottimizzazione
            await OptimizeSingleFile(file);
        }

        // Reset the file input so the user can select more files
        await JS.InvokeVoidAsync("clearFileInput", fileInputRef);

        StateHasChanged();
    }


    private async Task OptimizeSingleFile(FileEntry file)
    {
        try
        {
            var res = await JS.InvokeAsync<NativeResult>("compressNativeVelo", file.FileId, file.Quality, file.OutputFormat);

            file.Url = res.Url;
            file.Data = res.Data;
            file.CompressedSize = res.Data.Length;
            file.Savings = Math.Round(100 - ((double)res.Data.Length / res.OrigSize * 100), 1);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error optimizing file: {ex.Message}");
        }

        StateHasChanged();
    }

    private async Task RemoveFile(FileEntry file)
    {
        await JS.InvokeVoidAsync("removeFromCache", file.FileId);
        pendingFiles.Remove(file);
        
        if (selectedFile == file)
        {
            selectedFile = pendingFiles.FirstOrDefault();
        }

        StateHasChanged();
    }

    private async Task ClearAllFiles()
    {
        // Pulizia della memoria per tutti i file
        foreach (var file in pendingFiles)
        {
            await JS.InvokeVoidAsync("removeFromCache", file.FileId);
        }

        // Svuota la lista
        pendingFiles.Clear();
        selectedFile = null;

        StateHasChanged();
    }

    private async Task DownloadZip()
    {
        using var ms = new MemoryStream();
        using (var archive = new ZipArchive(ms, ZipArchiveMode.Create, true))
        {
            foreach (var file in pendingFiles.Where(f => f.Data != null))
            {
                var ext = file.OutputFormat == "jpeg" ? ".jpg" : "." + file.OutputFormat;
                var entryName = Path.ChangeExtension(file.Name, ext);
                var entry = archive.CreateEntry(entryName);
                using var entryStream = entry.Open();
                await entryStream.WriteAsync(file.Data!, 0, file.Data!.Length);
            }
        }
        ms.Position = 0;
        using var streamRef = new DotNetStreamReference(ms);
        await JS.InvokeVoidAsync("downloadFromStream", "images.zip", streamRef);
    }

    private async Task TriggerFileSelect()
    {
        await JS.InvokeVoidAsync("triggerClick", fileInputRef);
    }

    private async Task ResetZoom()
    {
        await JS.InvokeVoidAsync("previewZoom.reset", veloContainerRef);
    }

    private async Task DownloadSingleFile(FileEntry file)
    {
        SelectFile(file);
        if (file.Data != null)
        {
            var ext = file.OutputFormat == "jpeg" ? ".jpg" : "." + file.OutputFormat;
            var fileName = Path.ChangeExtension(file.Name, ext);
            using var ms = new MemoryStream(file.Data);
            using var streamRef = new DotNetStreamReference(ms);
            await JS.InvokeVoidAsync("downloadFromStream", fileName, streamRef);
        }
    }

    private async Task ResetQuality(FileEntry file)
    {
        SelectFile(file);
        // Resetta la qualità al valore di default (75)
        file.Quality = 75;

        // Riesegue l'ottimizzazione per aggiornare il peso del file
        await OptimizeSingleFile(file);

        StateHasChanged();
    }

    private async Task ChangeFormat(ChangeEventArgs e, FileEntry file)
    {
        SelectFile(file);
        file.OutputFormat = e.Value?.ToString() ?? "jpeg";
        await OptimizeSingleFile(file);
    }

    private async Task ChangeGlobalFormat(ChangeEventArgs e)
    {
        var format = e.Value?.ToString();
        if (string.IsNullOrEmpty(format)) return;

        foreach (var file in pendingFiles)
        {
            file.OutputFormat = format;
            await OptimizeSingleFile(file);
        }
        globalFormat = "";
    }

    private void UpdateQualityValue(ChangeEventArgs e, FileEntry file)
    {
        SelectFile(file);
        if (int.TryParse(e.Value?.ToString(), out var newVal))
        {
            file.Quality = newVal;
            // Aggiorna solo il numero nella UI della lista
        }
    }

    private string FormatSize(long bytes)
    {
        var culture = CultureInfo.CurrentCulture;

        if (bytes >= 1024 * 1024)
        {
            return (bytes / 1024.0 / 1024.0).ToString("N1", culture) + " MB";
        }
        if (bytes >= 1024)
        {
            return (bytes / 1024.0).ToString("N1", culture) + " KB";
        }
        return bytes.ToString("N0", culture) + " B";
    }

    public class NativeResult
    {
        public string Url { get; set; }
        public byte[] Data { get; set; }
        public long OrigSize { get; set; }
    }
}