<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Velo</title>
    <base href="/VELO-Image-Size-Optimizer/" />
    <link
        href="css/bootstrap/bootstrap.min.css"
        rel="stylesheet"
    />
    <link
        href="css/app.css"
        rel="stylesheet"
    />
    <link
        rel="icon"
        type="image/png"
        href="favicon.png"
    />
    <link
        href="Velo.styles.css"
        rel="stylesheet"
    />

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Inter:wght@400&display=swap" rel="stylesheet">
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle
                r="40%"
                cx="50%"
                cy="50%"
            />
            <circle
                r="40%"
                cx="50%"
                cy="50%"
            />
        </svg>
        <div class="loading-progress-text"></div>
    </div>
    <div id="blazor-error-ui"> An unhandled error has occurred. <a
            href=""
            class="reload"
        >Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    
    <script>
        // Magazzino temporaneo per i file
        let veloFileCache = [];

        window.getSelectedFilesInfo = (element) => {
            const newFiles = Array.from(element.files);
            const info = [];

            newFiles.forEach(file => {
                // Salviamo il file reale nella cache
                const fileId = Date.now() + Math.random();
                veloFileCache.push({ id: fileId, file: file });

                info.push({
                    name: file.name,
                    size: file.size,
                    internalId: fileId // Usiamo questo ID invece dell'indice
                });
            });

            element.value = ''; // Reset immediato dell'input
            return info;
        };

        window.compressNativeVelo = async (fileId, quality) => {
            // Cerchiamo il file nella nostra cache tramite l'ID unico
            const cacheEntry = veloFileCache.find(e => e.id === fileId);
            if (!cacheEntry) throw new Error("File non trovato nella cache di Velo");

            const file = cacheEntry.file;
            const bitmap = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(bitmap, 0, 0);

            const blob = await new Promise(resolve =>
                canvas.toBlob(resolve, 'image/jpeg', quality / 100)
            );

            return {
                data: new Uint8Array(await blob.arrayBuffer()),
                url: URL.createObjectURL(blob),
                origSize: file.size,
                fileName: file.name
            };
        };

        window.removeFromCache = (fileId) => {
            veloFileCache = veloFileCache.filter(e => e.id !== fileId);
        };

        window.clearVeloCache = () => {
            veloFileCache = [];
        };

    </script>
</body>

</html>