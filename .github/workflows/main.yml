name: Deploy Velo
on:
  push:
    branches: [ main ]
jobs:
  serve:
    name: Serve with Nginx (preview)
    runs-on: ubuntu-latest
    # Trigger manually via workflow_dispatch for previewing with nginx
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Install Nginx
        run: |
          sudo apt-get update
          sudo apt-get install -y nginx

      - name: Copy site files to nginx root
        run: |
          sudo rm -rf /var/www/html/*
          sudo cp -r Project/* /var/www/html/
          sudo chown -R www-data:www-data /var/www/html || true

      - name: Start Nginx
        run: |
          sudo systemctl restart nginx || sudo service nginx start

      - name: Verify index is served
        run: |
          sleep 2
          curl --fail http://localhost/ -o /tmp/index.html
          echo "Index served OK"
