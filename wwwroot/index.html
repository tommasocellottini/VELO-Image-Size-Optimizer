<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Velo</title>
    <!-- <base href="/" /> -->
    <base href="/VELO-Image-Size-Optimizer/" />
    <link
        href="css/bootstrap/bootstrap.min.css"
        rel="stylesheet"
    />
    <link
        href="css/app.css"
        rel="stylesheet"
    />
    <link
        rel="icon"
        type="image/png"
        href="favicon.png"
    />
    <link
        href="Velo.styles.css"
        rel="stylesheet"
    />
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Inter:wght@400&display=swap"
        rel="stylesheet"
    >
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle
                r="40%"
                cx="50%"
                cy="50%"
            />
            <circle
                r="40%"
                cx="50%"
                cy="50%"
            />
        </svg>
        <div class="loading-progress-text"></div>
    </div>
    <div id="blazor-error-ui"> An unhandled error has occurred. <a
            href=""
            class="reload"
        >Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        if (typeof window.veloFileCache === 'undefined') {
            window.veloFileCache = {};
        }

        window.getSelectedFilesInfo = async (inputElement) => {
            const files = Array.from(inputElement.files);
            const info = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // Creiamo un ID che sia sicuramente una stringa
                const id = "FILE_" + Date.now() + "_" + i;

                // SALVATAGGIO CRUCIALE
                window.veloFileCache[id] = file;

                console.log(`Cache popolata per: ${id}`, window.veloFileCache[id]);

                info.push({
                    name: file.name,
                    size: file.size,
                    fileId: id,
                    is420: true // Placeholder per YCbCrRatio420
                });
            }
            return info;
        };

        window.compressNativeVelo = async (fileId, quality) => {
            const file = window.veloFileCache[fileId];
            if (!file) throw new Error("File non trovato nella cache di Velo");

            // 1. Trasformiamo il file in un oggetto immagine
            const bitmap = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            const ctx = canvas.getContext('2d');

            // 2. Disegniamo l'immagine sul canvas
            ctx.drawImage(bitmap, 0, 0);

            // 3. COMPRESSIONE REALE: Trasformiamo in Blob con qualitÃ  ridotta (0.75 = 75%)
            // Usiamo image/jpeg o image/webp per supportare il parametro quality
            const compressedBlob = await new Promise(resolve =>
                canvas.toBlob(resolve, 'image/jpeg', quality / 100)
            );

            // 4. Prepariamo i dati per Blazor
            const arrayBuffer = await compressedBlob.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            return {
                fileName: file.name.replace(/\.[^/.]+$/, "") + "_compressed.jpg",
                url: URL.createObjectURL(compressedBlob),
                data: uint8Array,
                origSize: file.size
            };
        };

        window.removeFromCache = (fileId) => {
            veloFileCache = veloFileCache.filter(e => e.id !== fileId);
        };

        window.clearVeloCache = () => {
            veloFileCache = [];
        };

        window.downloadAsZip = async (filesJson) => {
            const zip = new JSZip();
            const folder = zip.folder("Velo_Optimized");
            const files = JSON.parse(filesJson);

            for (const file of files) {
                // Decodifichiamo la stringa Base64 o l'array in un Uint8Array
                // Se passiamo l'oggetto da Blazor, i dati arrivano spesso come stringa Base64
                folder.file(file.fileName, file.data, { base64: true });
            }

            const content = await zip.generateAsync({ type: "blob" });
            const zipUrl = URL.createObjectURL(content);

            const link = document.createElement('a');
            link.href = zipUrl;
            link.download = "Velo_Images_Pack.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

    </script>
</body>

</html>